@model Futurist.Service.Dto.AnlRmPriceDto

@{
    ViewBag.Title = "Analisa RM Price";
    ViewBag.pageTitle = "Analisa RM Price";
    Layout = "_Layout";
}

@section styles{
    <link href="/assets/css/datatables.min.css" rel="stylesheet">
    <link href="/assets/css/select2/select2.min.css" rel="stylesheet"/>
    <link href="/assets/css/select2/select2-bootstrap-5-theme.min.css" rel="stylesheet"/>
}

@Html.AntiForgeryToken()

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h1>Analisa RM Price</h1>
                <!-- Dropdown for room ids -->
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label" for="roomSelect">Room</label>
                        <select class="form-control" id="roomSelect"></select>
                    </div>
                    <div class="col-6">
                        <label class="form-label" for="verIdSelect">Version</label>
                        <select class="form-control" id="verIdSelect" disabled></select>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label" for="yearSelect">Year</label>
                        <select class="form-control" id="yearSelect" disabled></select>
                    </div>
                    <div class="col-6">
                        <label class="form-label" for="monthSelect">Month</label>
                        <select class="form-control" id="monthSelect" disabled></select>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <table id="datatables-anl-rm-price" class="display table table-bordered dt-responsive datatable-wrapper" style="width:100%">
                    <thead>
                    <tr>
                        <th>Room</th>
                        <th>Ver ID</th>
                        <th>Year</th>
                        <th>Month</th>
                        <th>Group Substitusi</th>
                        <th>Group Procurement</th>
                        <th>Item ID</th>
                        <th>Item Name</th>
                        <th>Unit</th>
                        <th>Plan Qty</th>
                        <th>Plan Value</th>
                        <th>Plan Price</th>
                        <th>Act Qty</th>
                        <th>Act Value</th>
                        <th>Act Price</th>
                        <th>Cont</th>
                        <th>A/P</th>
                    </tr>
                    </thead>
                    <tfoot>
                    <tr>
                        <th>Room</th>
                        <th>Ver ID</th>
                        <th>Year</th>
                        <th>Month</th>
                        <th>Group Substitusi</th>
                        <th>Group Procurement</th>
                        <th>Item ID</th>
                        <th>Item Name</th>
                        <th>Unit</th>
                        <th>Plan Qty</th>
                        <th>Plan Value</th>
                        <th>Plan Price</th>
                        <th>Act Qty</th>
                        <th>Act Value</th>
                        <th>Act Price</th>
                        <th>Cont</th>
                        <th>A/P</th>
                    </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="/assets/js/datatables.min.js"></script>
    <script src="/assets/js/helper.js"></script>
    <script src="/assets/js/select2/select2.min.js"></script>
    
    <script>
        const token = $('input[name="__RequestVerificationToken"]').val();
        const roomSelect = $('#roomSelect');
        const verIdSelect = $('#verIdSelect');
        const yearSelect = $('#yearSelect');
        const monthSelect = $('#monthSelect');
        const datatablesAnlRmPrice = $('#datatables-anl-rm-price');
        let dataTableInstance = null;

        // Helper to clear and trigger change
        function clearSelect($select) {
            $select.val(null).trigger('change');
        }

        // Room dropdown
        roomSelect.select2({
            placeholder: "Select Room",
            ajax: {
                url: '/api/AnlRmApi/GetRoomIds',
                type: 'GET',
                dataType: 'json',
                delay: 500,
                headers: { 'RequestVerificationToken': token },
                processResults: function (data) {
                    return {
                        results: data.data.map(room => ({ id: room, text: room }))
                    };
                },
            }
        });

        // VerId dropdown (depends on room)
        function loadVerIds(room) {
            verIdSelect.select2({
                placeholder: "Select Version",
                ajax: {
                    url: '/api/ReportVersionApi/GetVersions',
                    type: 'GET',
                    dataType: 'json',
                    delay: 500,
                    headers: { 'RequestVerificationToken': token },
                    data: function() { return { room: room }; },
                    processResults: function (data) {
                        return {
                            // combine verId, verDate and notes into a single text
                            results: data.data.map(version => ({ id: version.verId, text: `Version: ${version.verId} | ${moment(version.verDate).format("DD MMM YYYY")} | ${version.notes}` }))
                        };
                    },
                }
            });
        }

        // Year dropdown (depends on room, verid)
        function loadYears(room, verid) {
            yearSelect.select2({
                placeholder: "Select Year",
                ajax: {
                    url: '/api/AnlRmApi/GetYears',
                    type: 'GET',
                    dataType: 'json',
                    delay: 500,
                    headers: { 'RequestVerificationToken': token },
                    data: function() { return { room: room, verid: verid }; },
                    processResults: function (data) {
                        return {
                            results: data.data.map(year => ({ id: year, text: year }))
                        };
                    },
                }
            });
        }

        // Month dropdown (depends on room, verid, year)
        function loadMonths(room, verid, year) {
            monthSelect.select2({
                placeholder: "Select Month",
                ajax: {
                    url: '/api/AnlRmApi/GetMonths',
                    type: 'GET',
                    dataType: 'json',
                    delay: 500,
                    headers: { 'RequestVerificationToken': token },
                    data: function() { return { room: room, verid: verid, year: year }; },
                    processResults: function (data) {
                        return {
                            // convert month numbers to names
                            results: data.data.map(month => ({ id: month, text: moment().month(month - 1).format("MMMM") }))
                        };
                    },
                }
            });
        }

        // Cascading logic
        roomSelect.on('change', function() {
            clearSelect(verIdSelect);
            clearSelect(yearSelect);
            clearSelect(monthSelect);
            verIdSelect.empty();
            yearSelect.empty();
            monthSelect.empty();

            // Enable/disable logic
            if (roomSelect.val()) {
                verIdSelect.prop('disabled', false);
                loadVerIds(roomSelect.val());
            } else {
                verIdSelect.prop('disabled', true);
            }
            yearSelect.prop('disabled', true);
            monthSelect.prop('disabled', true);

            reloadDataTable();
        });

        verIdSelect.on('change', function() {
            clearSelect(yearSelect);
            clearSelect(monthSelect);
            yearSelect.empty();
            monthSelect.empty();

            // Enable/disable logic
            if (roomSelect.val() && verIdSelect.val()) {
                yearSelect.prop('disabled', false);
                loadYears(roomSelect.val(), verIdSelect.val());
            } else {
                yearSelect.prop('disabled', true);
            }
            monthSelect.prop('disabled', true);

            reloadDataTable();
        });

        yearSelect.on('change', function() {
            clearSelect(monthSelect);
            monthSelect.empty();

            // Enable/disable logic
            if (roomSelect.val() && verIdSelect.val() && yearSelect.val()) {
                monthSelect.prop('disabled', false);
                loadMonths(roomSelect.val(), verIdSelect.val(), yearSelect.val());
            } else {
                monthSelect.prop('disabled', true);
            }

            reloadDataTable();
        });

        monthSelect.on('change', function() {
            reloadDataTable();
        });

        // Add a refresh button handler
        function getRefreshButton() {
            return {
                text: '<i class="ri-refresh-line"></i> Refresh',
                className: 'btn btn-soft-secondary',
                action: function (e, dt, node, config) {
                    dt.ajax.reload();
                },
                titleAttr: 'Refresh Table'
            };
        }

        // DataTable loader
        function reloadDataTable() {
            // Only load if all dropdowns have value
            if (roomSelect.val() && verIdSelect.val() && yearSelect.val() && monthSelect.val()) {
                if (dataTableInstance) {
                    dataTableInstance.ajax.reload();
                } else {
                    dataTableInstance = datatablesAnlRmPrice.DataTable({
                        destroy: true,
                        searchDelay: 1000,
                        layout: {
                            topEnd: {
                                buttons: [
                                    getRefreshButton(),
                                    // 'copy', 'excel', 'pdf'
                                    {
                                        extend: 'copyHtml5',
                                        text: '<i class="ri-file-copy-line"></i> Copy',
                                        className: 'btn btn-soft-secondary',
                                        titleAttr: 'Copy to clipboard'
                                    },
                                    {
                                        extend: 'excelHtml5',
                                        text: '<i class="ri-file-excel-2-line"></i> Excel',
                                        className: 'btn btn-soft-secondary',
                                        titleAttr: 'Export to Excel'
                                    },
                                    {
                                        extend: 'pdfHtml5',
                                        text: '<i class="ri-file-pdf-line"></i> PDF',
                                        className: 'btn btn-soft-secondary',
                                        titleAttr: 'Export to PDF'
                                    }
                                ]
                            }
                        },
                        ajax: {
                            url: '/api/AnlRmApi/GetAnlRmpPrice',
                            data: function() {
                                return {
                                    room: roomSelect.val(),
                                    verid: verIdSelect.val(),
                                    year: yearSelect.val(),
                                    month: monthSelect.val()
                                };
                            },
                            beforeSend: function(xhr) {
                                xhr.setRequestHeader("RequestVerificationToken", token);
                            },
                            dataSrc: function(json) {
                                if (json.data && Array.isArray(json.data.items)) {
                                    return json.data.items;
                                }
                                if (Array.isArray(json.data)) {
                                    return json.data;
                                }
                                return json;
                            },
                            error: function(err){
                                alert(err.responseJSON.errorMessage);
                            }
                        },
                        columns: [
                            { data: 'room', width: '30px', defaultContent: '' },
                            { data: 'verId', width: '30px', defaultContent: '' },
                            { data: 'year', width: '30px', defaultContent: '' },
                            { data: 'month', width: '30px', defaultContent: '' },
                            { data: 'groupSubstitusi', defaultContent: '' },
                            { data: 'groupProcurement', defaultContent: '' },
                            { data: 'itemId', defaultContent: '' },
                            { data: 'itemName', width: '200px', defaultContent: '' },
                            { data: 'unitId', defaultContent: '' },
                            { 
                                data: 'planQty', 
                                defaultContent: '', 
                                render: function(data, type) {
                                    // For sorting/filtering use the raw number
                                    if (type === 'sort' || type === 'filter') {
                                        return data ? parseFloat(data) : 0;
                                    }

                                    // For display, format with decimal places
                                    return data ? numberFormat.format(data) : '';
                                } 
                            },
                            {
                                data: 'planValue',
                                defaultContent: '', 
                                render: function(data, type) {
                                    // For sorting/filtering use the raw number
                                    if (type === 'sort' || type === 'filter') {
                                        return data ? parseFloat(data) : 0;
                                    }

                                    // For display, format with decimal places
                                    return data ? numberFormat.format(data) : '';
                                }
                            },
                            {
                                data: 'planPrice',
                                defaultContent: '',
                                render: function(data, type) {
                                    // For sorting/filtering use the raw number
                                    if (type === 'sort' || type === 'filter') {
                                        return data ? parseFloat(data) : 0;
                                    }

                                    // For display, format with decimal places
                                    return data ? numberFormat.format(data) : '';
                                }
                            },
                            {
                                data: 'actQty',
                                defaultContent: '',
                                render: function (data, type) {
                                    // For sorting/filtering use the raw number
                                    if (type === 'sort' || type === 'filter') {
                                        return data ? parseFloat(data) : 0;
                                    }

                                    // For display, format with decimal places
                                    return data ? numberFormat.format(data) : '';
                                }
                            },
                            {
                                data: 'actValue',
                                defaultContent: '',
                                render: function(data, type) {
                                    // For sorting/filtering use the raw number
                                    if (type === 'sort' || type === 'filter') {
                                        return data ? parseFloat(data) : 0;
                                    }

                                    // For display, format with decimal places
                                    return data ? numberFormat.format(data) : '';
                                }
                            },
                            {
                                data: 'actPrice',
                                defaultContent: '',
                                render: function(data, type) {
                                    // For sorting/filtering use the raw number
                                    if (type === 'sort' || type === 'filter') {
                                        return data ? parseFloat(data) : 0;
                                    }

                                    // For display, format with decimal places
                                    return data ? numberFormat.format(data) : '';
                                }
                            },
                            {
                                data: 'cont',
                                defaultContent: '',
                                render: function(data, type) {
                                    // For sorting/filtering use the raw number
                                    if (type === 'sort' || type === 'filter') {
                                        return data ? parseFloat(data) : 0;
                                    }

                                    // For display, format with decimal places
                                    return data ? percentFormat.format(data) : '';
                                }
                            },
                            {
                                data: 'ap',
                                defaultContent: '',
                                render: function(data, type) {
                                    // For sorting/filtering use the raw number
                                    if (type === 'sort' || type === 'filter') {
                                        return data ? parseFloat(data) : 0;
                                    }

                                    // For display, format with decimal places
                                    return data ? percentFormat.format(data) : '';
                                }
                            }
                        ],
                        columnDefs: [
                            {
                                targets: [0, 1, 2, 3, 6, 8],
                                className: 'text-center'
                            }
                        ],
                        processing: true,
                        paging: true,
                        searching: true,
                        autoWidth: false,
                        responsive: false,
                        scrollX: true,
                        order: [],
                        initComplete: function () {
                            this.api()
                                .columns()
                                .every(function () {
                                    let column = this;
                                    let title = column.footer().textContent;
                                    let header = column.header();
                                    header.style.backgroundColor = '#4F81BD';
                                    header.style.color = 'white';
                                    let input = document.createElement('input');
                                    input.placeholder = title;
                                    input.className = "form-control";
                                    input.style.width = '100%';
                                    column.footer().replaceChildren(input);
                                    input.addEventListener('keyup', debounce(() => {
                                        if (column.search() !== input.value) {
                                            column.search(input.value).draw();
                                        }
                                    }, 1000));
                                });
                        }
                    });
                }
            } else if (dataTableInstance) {
                dataTableInstance.clear().draw();
            }
        }

        $(document).ready(function() {
            // Ensure only roomSelect is enabled on load
            roomSelect.prop('disabled', false);
            verIdSelect.prop('disabled', true);
            yearSelect.prop('disabled', true);
            monthSelect.prop('disabled', true);
        });
    </script>
}
